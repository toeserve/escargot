{%- macro contact_entry(ab_id, contact, detail) -%}
	<contactId>{{ contact.uuid }}</contactId>
	<contactInfo>
		{%- if contact.personal_email or contact.work_phone or contact.im_email or contact.other_email -%}
			<emails>
				{%- if contact.work_email -%}
					{{ email_entry('ContactEmailBusiness', contact.work_email) }}
				{%- endif -%}
				{%- if contact.im_email -%}
					{{ email_entry('ContactEmailMessenger', contact.im_email) }}
				{%- endif -%}
				{%- if contact.other_email -%}
					{{ email_entry('ContactEmailOther', contact.other_email) }}
				{%- endif -%}
				{%- if contact.personal_email -%}
					{{ email_entry('ContactEmailPersonal', contact.personal_email) }}
				{%- endif -%}
			</emails>
		{%- endif -%}
		{%- if contact.home_phone or contact.work_phone or contact.fax_phone or contact.pager_phone or contact.mobile_phone or contact.other_phone -%}
			<phones>
				{%- if contact.work_phone -%}
					{{ phone_entry('ContactPhoneBusiness', contact.work_phone) }}
				{%- endif -%}
				{%- if contact.fax_phone -%}
					{{ phone_entry('ContactPhoneFax', contact.fax_phone) }}
				{%- endif -%}
				{%- if contact.pager_phone -%}
					{{ phone_entry('ContactPhonePager', contact.pager_phone) }}
				{%- endif -%}
				{%- if contact.mobile_phone -%}
					{{ phone_entry('ContactPhoneMobile', contact.mobile_phone) }}
				{%- endif -%}
				{%- if contact.other_phone -%}
					{{ phone_entry('ContactPhoneOther', contact.other_phone) }}
				{%- endif -%}
				{%- if contact.home_phone -%}
					{{ phone_entry('ContactPhonePersonal', contact.home_phone) }}
				{%- endif -%}
			</phones>
		{%- endif -%}
		{%- if contact.locations -%}
			<locations>
				{%- for location in contact.locations.values() -%}
					{%- if location.street or location.city or location.state or location.country or location.zip_code -%}
						<ContactLocation>
							<contactLocationType>{{ location.type }}</contactLocationType>
							{%- if location.street -%}
								<street>{{ location.street }}</street>
							{%- endif -%}
							{%- if location.city -%}
								<city>{{ location.city }}</city>
							{%- endif -%}
							{%- if location.state -%}
								<state>{{ location.state }}</state>
							{%- endif -%}
							{%- if location.country -%}
								<country>{{ location.country }}</country>
							{%- endif -%}
							{%- if location.zip_code -%}
								<postalCode>{{ location.zip_code }}</postalCode>
							{%- endif -%}
						</ContactLocation>
					{%- endif -%}
				{%- endfor -%}
			</locations>
		{%- endif -%}
		{%- if contact.personal_website or contact.business_website -%}
			<webSites>
				{%- if contact.business_website -%}
					{{ website_entry('ContactWebSiteBusiness', contact.business_website) }}
				{%- endif -%}
				{%- if contact.personal_website -%}
					{{ website_entry('ContactWebSitePersonal', contact.personal_website) }}
				{%- endif -%}
			</webSites>
		{%- endif -%}
		{%- if contact.annotations or contact.nickname -%}
			<annotations>
			{%- if contact.nickname -%}
				{{ annotation('AB.NickName', contact.nickname) }}
			{%- endif -%}
			{%- if contact.annotations -%}
				{%- for name, value in contact.annotations.items() -%}
					{{ annotation(name, value) }}
				{%- endfor -%}
			{%- endif -%}
			</annotations>
		{%- endif -%}
		<contactType>{{ contact.type }}</contactType>
		<quickName>{{ contact.name or contact.email }}</quickName>
		{%- if contact.first_name -%}
			<firstName>{{ contact.first_name }}</firstName>
		{%- endif -%}
		{%- if contact.middle_name -%}
			<MiddleName>{{ contact.middle_name }}</MiddleName>
		{%- endif -%}
		{%- if contact.last_name -%}
			<lastName>{{ contact.last_name }}</lastName>
		{%- endif -%}
		<passportName>{{ contact.email }}</passportName>
		<IsPassportNameHidden>false</IsPassportNameHidden>
		<displayName>{{ contact.name or contact.email }}</displayName>
		{%- if contact.member_uuid -%}
			<puid>0</puid>
		{%- endif -%}
		{%- if contact.groups -%}
			<groupIds>
			{% for group_id in contact.groups %}
				<guid>{{ group_id }}</guid>
			{% endfor %}
			</groupIds>
		{%- endif -%}
		{%- if contact.member_uuid -%}
			<CID>{{ cid_format(contact.member_uuid, decimal = True) }}</CID>
		{%- endif -%}
		<IsNotMobileVisible>false</IsNotMobileVisible>
		<isMobileIMEnabled>false</isMobileIMEnabled>
		<isMessengerUser>{{ bool_to_str(contact.is_messenger_user) }}</isMessengerUser>
		<isFavorite>{%- if ab_id == '00000000-0000-0000-0000-000000000000' -%}{{ bool_to_str(contact_is_favorite(detail.groups, contact)) }}{%- else -%}false{%- endif -%}</isFavorite>
		<isSmtp>false</isSmtp>
		<hasSpace>false</hasSpace>
		<spotWatchState>NoDevice</spotWatchState>
		<birthdate>{%- if contact.birthdate -%}{{ date_format(contact.birthdate) }}{%- else -%}0001-01-01T00:00:00{%- endif -%}</birthdate>
		{%- if contact.anniversary -%}
			<Anniversary>{{ contact.anniversary.strftime('%Y/%m/%d') }}</Anniversary>
		{%- endif -%}
		{%- if contact.notes -%}
			<comment>{{ contact.notes }}</comment>
		{%- endif -%}
		<primaryEmailType>{%- if contact.primary_email_type -%}{{ contact.primary_email_type }}{%- else -%}ContactEmailPersonal{%- endif -%}</primaryEmailType>
		<PrimaryLocation>ContactLocationPersonal</PrimaryLocation>
		<PrimaryPhone>ContactPhonePersonal</PrimaryPhone>
		<IsPrivate>false</IsPrivate>
		<Gender>Unspecified</Gender>
		<TimeZone>None</TimeZone>
		{%- if contact.networkinfos -%}
			<NetworkInfoList>
			{%- for networkinfo in contact.networkinfos.values() -%}
				<NetworkInfo>
					<DomainId>{{ networkinfo.domain_id.value }}</DomainId>
					<SourceId>{{ networkinfo.source_id }}</SourceId>
					<DomainTag>{{ networkinfo.domain_tag }}</DomainTag>
					<ProfileURL>https://escargot.log1p.xyz</ProfileURL>
					<DisplayName>{{ networkinfo.display_name }}</DisplayName>
					<RelationshipType>{{ networkinfo.relationship_info.relationship_type.value }}</RelationshipType>
					<RelationshipState>{{ networkinfo.relationship_info.relationship_state.value }}</RelationshipState>
					<RelationshipStateDate>{{ date_format(networkinfo.relationship_info.relationship_state_date) }}</RelationshipStateDate>
					<RelationshipRole>{{ networkinfo.relationship_info.relationship_role.value }}</RelationshipRole>
					<NDRCount>0</NDRCount>
					{%- if networkinfo.inviter_message -%}
						<InviterMessage>{{ networkinfo.inviter_message }}</InviterMessage>
					{%- endif -%}
					<InviterCID>0</InviterCID>
					<CreateDate>{{ date_format(networkinfo.date_created) }}</CreateDate>
					<LastChanged>{{ date_format(networkinfo.date_modified) }}</LastChanged>
					<PropertiesChanged />
					<Settings>0</Settings>
				</NetworkInfo>
			{%- endfor -%}
			</NetworkInfoList>
		{%- endif -%}
	</contactInfo>
	<propertiesChanged />
	<fDeleted>false</fDeleted>
	<lastChange>{{ date_format(contact.date_modified) }}</lastChange>
{%- endmacro -%}

{%- macro phone_entry(type, phone) -%}
	<ContactPhone>
		<contactPhoneType>{{ type }}</contactPhoneType>
		<number>{{ phone }}</number>
		<isMessengerEnabled>false</isMessengerEnabled>
	</ContactPhone>
{%- endmacro -%}

{%- macro email_entry(type, email) -%}
	<ContactEmail>
		<contactEmailType>{{ type }}</contactEmailType>
		<email>{{ email }}</email>
		<isMessengerEnabled>false</isMessengerEnabled>
		<Capability>0</Capability>
		<MessengerEnabledExternally>false</MessengerEnabledExternally>
	</ContactEmail>
{%- endmacro -%}

{%- macro website_entry(type, url) -%}
	<ContactWebSite>
		<contactWebSiteType>{{ type }}</contactWebSiteType>
		<webURL>{{ url }}</webURL>
	</ContactWebSite>
{%- endmacro -%}

{%- macro annotation(name, value) -%}
	<Annotation>
		<Name>{{ name }}</Name>
		<Value>{{ value }}</Value>
	</Annotation>
{%- endmacro -%}

{%- macro generate_me_entry(ab_id, user_creator, now) -%}
	<Contact>
		<contactId>{{ user_creator.uuid }}</contactId>
		<contactInfo>
			{%- if ab_id == '00000000-0000-0000-0000-000000000000' -%}
				<annotations>
					<Annotation>
						<Name>MSN.IM.MBEA</Name>
						<Value>0</Value>
					</Annotation>
					<Annotation>
						<Name>MSN.IM.GTC</Name>
						<Value>{%- if user_creator.settings.get('GTC') == 'A' -%}1{%- elif user_creator.settings.get('GTC') == 'N' -%}2{%- else -%}0{%- endif -%}</Value>
					</Annotation>
					<Annotation>
						<Name>MSN.IM.BLP</Name>
						<Value>{%- if user_creator.settings.get('BLP') == 'AL' -%}1{%- elif user_creator.settings.get('BLP') == 'BL' -%}2{%- else -%}0{%- endif -%}</Value>
					</Annotation>
					{%- if user_creator.settings.get('MPOP') -%}
						<Annotation>
							<Name>MSN.IM.RoamLiveProperties</Name>
							<Value>{{ user_creator.settings.get('MPOP') }}</Value>
						</Annotation>
					{%- endif -%}
					{%- if user_creator.settings.get('RLP') -%}
						<Annotation>
							<Name>MSN.IM.RoamLiveProperties</Name>
							<Value>{{ user_creator.settings.get('RLP') }}</Value>
						</Annotation>
					{%- endif -%}
				</annotations>
			{%- endif -%}
			<contactType>Me</contactType>
			<quickName>{{ user_creator.status.name or user_creator.email }}</quickName>
			<passportName>{{ user_creator.email }}</passportName>
			<IsPassportNameHidden>false</IsPassportNameHidden>
			{%- if user_creator.status.name -%}
				<displayName>{{ user_creator.status.name }}</displayName>
			{%- endif -%}
			<puid>0</puid>
			<CID>{{ cid_format(user_creator.uuid, decimal = True) }}</CID>
			<IsNotMobileVisible>false</IsNotMobileVisible>
			<isMobileIMEnabled>false</isMobileIMEnabled>
			<isMessengerUser>false</isMessengerUser>
			<isFavorite>false</isFavorite>
			<isSmtp>false</isSmtp>
			<hasSpace>false</hasSpace>
			<spotWatchState>NoDevice</spotWatchState>
			<birthdate>0001-01-01T00:00:00</birthdate>
			<primaryEmailType>ContactEmailPersonal</primaryEmailType>
			<PrimaryLocation>ContactLocationPersonal</PrimaryLocation>
			<PrimaryPhone>ContactPhonePersonal</PrimaryPhone>
			<IsPrivate>false</IsPrivate>
			<Gender>Unspecified</Gender>
			<TimeZone>None</TimeZone>
		</contactInfo>
		<propertiesChanged />
		<fDeleted>false</fDeleted>
		<lastChange>{{ now }}</lastChange>
	</Contact>
{%- endmacro -%}

{%- macro group_entry(group) -%}
	<Group>
		<groupId>{{ group.uuid }}</groupId>
		<groupInfo>
			<annotations>
				<Annotation>
					<Name>MSN.IM.Display</Name>
					<Value>1</Value>
				</Annotation>
			</annotations>
			<groupType>c8529ce2-6ead-434d-881f-341e17db3ff8</groupType>
			<name>{{ group.name }}</name>
			<IsNotMobileVisible>false</IsNotMobileVisible>
			<IsPrivate>false</IsPrivate>
			<IsFavorite>{{ bool_to_str(group.is_favorite) }}</IsFavorite>
		</groupInfo>
		<propertiesChanged />
		<fDeleted>false</fDeleted>
		<lastChange>{{ date_format(group.date_modified) }}</lastChange>
	</Group>
{%- endmacro -%}

{%- macro ab_properties(ab_id, user_creator, ab_type, ab_created, ab_last_modified, paged) -%}
	<abId>{{ ab_id }}</abId>
	<abInfo>
		<ownerPuid>0</ownerPuid>
		<OwnerCID>{{ cid_format(user_creator.uuid, decimal = True) }}</OwnerCID>
		<ownerEmail>{{ user_creator.email }}</ownerEmail>
		<fDefault>true</fDefault>
		<joinedNamespace>false</joinedNamespace>
		<IsBot>false</IsBot>
		<IsParentManaged>false</IsParentManaged>
		{%- if paged -%}
			<AccountTierLastChanged>0001-01-01T00:00:00</AccountTierLastChanged>
			<ProfileVersion>0</ProfileVersion>
		{%- endif -%}
		<SubscribeExternalPartner>false</SubscribeExternalPartner>
		<NotifyExternalPartner>false</NotifyExternalPartner>
		<AddressBookType>{{ ab_type }}</AddressBookType>
	</abInfo>
	<lastChange>{{ date_format(ab_last_modified) }}</lastChange>
	<DynamicItemLastChanged>0001-01-01T00:00:00</DynamicItemLastChanged>
	<createDate>{{ date_format(ab_created) }}</createDate>
	<propertiesChanged />
{%- endmacro -%}